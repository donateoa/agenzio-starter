import { Router, Response, NextFunction } from 'express';
import * as admin from 'firebase-admin';

const router = Router();
const db = admin.firestore();

// Simple auth middleware - verifies Firebase ID token
const checkAuth = async (req: any, res: Response, next: NextFunction) => {
  try {
    const authHeader = req.headers.authorization;
    if (!authHeader?.startsWith('Bearer ')) {
      return res.status(401).json({ error: 'No token provided' });
    }

    const token = authHeader.split('Bearer ')[1];
    const decodedToken = await admin.auth().verifyIdToken(token);
    req.user = decodedToken;
    next();
  } catch (error) {
    console.error('Auth error:', error);
    return res.status(401).json({ error: 'Invalid token' });
  }
};

// GET /me - Get current user profile (or create if doesn't exist)
router.get('/me', checkAuth, (async (req: any, res: Response) => {
  try {
    const uid = req.user.uid;
    const userRef = db.collection('users').doc(uid);
    const userDoc = await userRef.get();

    if (userDoc.exists) {
      return res.json({ id: userDoc.id, ...userDoc.data() });
    }

    // Create profile from Firebase Auth data
    const newProfile = {
      email: req.user.email || '',
      displayName: req.user.name || req.user.displayName || '',
      firstName: '',
      lastName: '',
      phone: '',
      photoURL: req.user.picture || null,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    await userRef.set(newProfile);
    return res.json({ id: uid, ...newProfile });
  } catch (error: any) {
    console.error('Get Profile Error:', error);
    return res.status(500).json({ error: 'Failed to fetch profile' });
  }
}) as any);

// GET /me/profile - Alias for /me
router.get('/me/profile', checkAuth, (async (req: any, res: Response) => {
  try {
    const uid = req.user.uid;
    const userRef = db.collection('users').doc(uid);
    const userDoc = await userRef.get();

    if (userDoc.exists) {
      return res.json({ id: userDoc.id, ...userDoc.data() });
    }

    // Create profile from Firebase Auth data
    const newProfile = {
      email: req.user.email || '',
      displayName: req.user.name || req.user.displayName || '',
      firstName: '',
      lastName: '',
      phone: '',
      photoURL: req.user.picture || null,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    await userRef.set(newProfile);
    return res.json({ id: uid, ...newProfile });
  } catch (error: any) {
    console.error('Get Profile Error:', error);
    return res.status(500).json({ error: 'Failed to fetch profile' });
  }
}) as any);

// PUT /me/profile - Update current user profile
router.put('/me/profile', checkAuth, (async (req: any, res: Response) => {
  try {
    const uid = req.user.uid;
    const { firstName, lastName, phone, displayName } = req.body;

    const userRef = db.collection('users').doc(uid);
    const updateData: any = {
      updatedAt: new Date().toISOString()
    };

    if (firstName !== undefined) updateData.firstName = firstName;
    if (lastName !== undefined) updateData.lastName = lastName;
    if (phone !== undefined) updateData.phone = phone;
    if (displayName !== undefined) updateData.displayName = displayName;

    // Auto-generate displayName if firstName and lastName provided
    if (firstName && lastName && !displayName) {
      updateData.displayName = `${firstName} ${lastName}`;
    }

    await userRef.set(updateData, { merge: true });

    const updatedDoc = await userRef.get();
    return res.json({ id: updatedDoc.id, ...updatedDoc.data() });
  } catch (error: any) {
    console.error('Update Profile Error:', error);
    return res.status(500).json({ error: 'Failed to update profile' });
  }
}) as any);

// DELETE /me - Delete current user account
router.delete('/me', checkAuth, (async (req: any, res: Response) => {
  try {
    const uid = req.user.uid;

    // Delete user document
    await db.collection('users').doc(uid).delete();

    // Delete PractitionerRoles where user is not OWNER
    const rolesSnap = await db.collection('practitionerRoles')
      .where('practitionerId', '==', uid)
      .get();

    const batch = db.batch();
    for (const roleDoc of rolesSnap.docs) {
      const roleData = roleDoc.data();
      if (roleData.roleCode !== 'OWNER') {
        batch.delete(roleDoc.ref);
      }
    }
    await batch.commit();

    return res.json({ success: true, message: 'Profile deleted' });
  } catch (error: any) {
    console.error('Delete Profile Error:', error);
    return res.status(500).json({ error: 'Failed to delete profile' });
  }
}) as any);

export default router;
