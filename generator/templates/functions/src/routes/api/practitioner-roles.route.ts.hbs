import { Router, Response, NextFunction } from 'express';
import * as admin from 'firebase-admin';

const router = Router();
const db = admin.firestore();

// Simple auth middleware
const checkAuth = async (req: any, res: Response, next: NextFunction) => {
  try {
    const authHeader = req.headers.authorization;
    if (!authHeader?.startsWith('Bearer ')) {
      return res.status(401).json({ error: 'No token provided' });
    }

    const token = authHeader.split('Bearer ')[1];
    const decodedToken = await admin.auth().verifyIdToken(token);
    req.user = decodedToken;
    next();
  } catch (error) {
    console.error('Auth error:', error);
    return res.status(401).json({ error: 'Invalid token' });
  }
};

/**
 * GET /
 * Get all practitioner roles for the authenticated user.
 */
router.get('/', checkAuth as any, (async (req: any, res: Response) => {
  try {
    const uid = req.user.uid;
    const email = req.user.email?.toLowerCase();

    // Get roles by UID
    const rolesByUidSnap = await db.collection('practitionerRoles')
      .where('practitionerId', '==', uid)
      .get();

    const roles: any[] = rolesByUidSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Get by email (for pending invitations)
    if (email) {
      const rolesByEmailSnap = await db.collection('practitionerRoles')
        .where('email', '==', email)
        .get();

      rolesByEmailSnap.docs.forEach(doc => {
        if (!roles.some(r => r.id === doc.id)) {
          roles.push({ id: doc.id, ...doc.data() });
        }
      });
    }

    return res.json(roles);
  } catch (error: any) {
    console.error('Get Practitioner Roles Error:', error);
    return res.status(500).json({ error: 'Failed to fetch practitioner roles' });
  }
}) as any);

/**
 * GET /organization/:orgId
 * Get all practitioner roles for a specific organization.
 */
router.get('/organization/:orgId', checkAuth as any, (async (req: any, res: Response) => {
  try {
    const orgId = req.params.orgId;

    const rolesSnap = await db.collection('practitionerRoles')
      .where('organizationId', '==', orgId)
      .get();

    const roles = rolesSnap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    return res.json(roles);
  } catch (error: any) {
    console.error('Get Organization Roles Error:', error);
    return res.status(500).json({ error: 'Failed to fetch organization roles' });
  }
}) as any);

export default router;
